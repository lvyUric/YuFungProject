# 保单管理导入导出功能实现说明

## 📋 功能概述

保单管理模块现已完整实现导入导出功能，支持Excel和CSV格式的文件处理，包括：

1. **模板下载功能** - 下载标准格式的导入模板
2. **数据导出功能** - 将保单数据导出为Excel/CSV文件  
3. **文件导入功能** - 从Excel/CSV文件批量导入保单数据
4. **数据预览功能** - 导入前预览和验证数据
5. **错误处理功能** - 详细的错误提示和处理

## 🎯 实现的功能特性

### ✅ 后端功能 (Go)

#### 1. 模板生成
- **Excel模板生成** (`generatePolicyExcelTemplate`) - 生成包含表头和示例数据的Excel模板
- **CSV模板生成** (`generatePolicyCSVTemplate`) - 生成CSV格式模板
- **支持字段**：序号、账户号、客户号、客户姓名、投保单号、保单币种、合作伙伴、转介信息、缴费信息、费率信息、产品信息等30个字段

#### 2. 数据导出
- **Excel导出** (`generatePolicyExcelData`) - 将保单数据导出为Excel格式
- **CSV导出** (`generatePolicyCSVData`) - 将保单数据导出为CSV格式
- **格式化处理** - 自动格式化日期、布尔值、数值等字段
- **汇率精度** - 汇率字段保留4位小数

#### 3. 数据导入
- **文件解析** - 支持Excel (.xlsx, .xls) 和 CSV (.csv) 文件解析
- **数据验证** - 严格的字段格式验证和业务规则检查
- **重复检测** - 检查投保单号和账户号的唯一性
- **预览功能** - 导入前预览前10条数据
- **错误报告** - 详细的行级错误信息

#### 4. API接口
```go
// 模板下载
GET /api/policies/template?type=xlsx

// 数据导出  
POST /api/policies/export?format=xlsx

// 导入预览
POST /api/policies/import/preview

// 文件导入
POST /api/policies/import
```

### ✅ 前端功能 (React + TypeScript)

#### 1. 用户界面
- **下载模板按钮** - 一键下载导入模板
- **文件上传组件** - 拖拽或点击上传文件
- **导入预览弹窗** - 显示解析结果和错误信息
- **导出选择** - 支持导出全部或选中的保单

#### 2. 交互体验
- **进度提示** - 上传、解析、导入过程的Loading提示
- **错误展示** - 友好的错误信息展示
- **结果反馈** - 详细的导入结果统计
- **确认机制** - 导入前的二次确认

#### 3. 数据处理
- **类型安全** - 完整的TypeScript类型定义
- **错误处理** - 优雅的异常处理机制
- **文件验证** - 上传前的文件格式验证

## 🏗️ 技术实现

### 后端技术栈
- **Excel处理**: `github.com/xuri/excelize/v2` - 高性能Excel文件处理
- **CSV处理**: Go标准库 `encoding/csv`
- **数据验证**: 自定义验证逻辑 + MongoDB约束
- **文件上传**: `multipart/form-data` 处理

### 前端技术栈  
- **UI组件**: Ant Design ProComponents
- **文件上传**: Ant Design Upload组件
- **API调用**: UmiJS request
- **类型定义**: TypeScript接口

## 📊 数据字段说明

### 导入模板字段（30个字段）
1. **基本信息**: 序号、账户号、客户号、客户中文名、客户英文名、投保单号
2. **保单信息**: 保单币种、合作伙伴、转介编号、港分客户经理、转介理财经理
3. **转介信息**: 转介分行、转介支行、转介日期
4. **缴费信息**: 缴费日期、生效日期、缴费方式、缴费年期、期缴期数
5. **费用信息**: 实际缴纳保费、AUM、转介费率、汇率、预计转介费、支付日期
6. **状态信息**: 是否员工
7. **产品信息**: 承保公司、保险产品名称、产品类型
8. **其他信息**: 备注说明

### 特殊字段处理
- **汇率字段**: 自动保留4位小数 (如: 6.9000)
- **日期字段**: 统一格式 YYYY-MM-DD (如: 2024-01-15)
- **布尔字段**: 支持 "是/否" 或 "true/false"
- **必填字段**: 投保单号为必填项，其他字段可选

## 🚀 使用方法

### 1. 下载模板
```javascript
// 前端调用
await downloadPolicyTemplate('xlsx');
```

### 2. 导出数据
```javascript
// 导出选中的保单
await exportPoliciesToFile({
  policy_ids: selectedIds,
  export_type: 'xlsx',
  format: 'xlsx'
});
```

### 3. 导入数据
```javascript
// 预览导入
const formData = new FormData();
formData.append('file', file);
formData.append('skip_header', 'true');
await previewPolicyImport(formData);

// 执行导入
await importPoliciesFromFile(formData);
```

## ⚠️ 注意事项

### 数据要求
1. **投保单号必须唯一** - 系统会检查全局唯一性
2. **汇率精度控制** - 自动保留4位小数
3. **文件大小限制** - 建议单次导入不超过1000条记录
4. **字段格式** - 严格按照模板格式填写

### 性能优化
1. **后台处理** - 大文件采用后台异步处理
2. **分批导入** - 超大数据量建议分批导入
3. **索引优化** - 投保单号已建立全局唯一索引

### 错误处理
1. **详细错误信息** - 具体到行号和字段
2. **部分成功** - 支持导入有效记录，跳过错误记录
3. **回滚机制** - 导入失败时不会产生脏数据

## 🔧 扩展建议

### 1. 功能增强
- 支持更多文件格式 (如: .ods)
- 批量更新现有记录
- 导入历史记录查询
- 定时导入任务

### 2. 性能优化
- 大文件流式处理
- 分块上传机制
- 后台异步处理队列
- 导入进度实时显示

### 3. 用户体验
- 拖拽上传界面
- 导入模板在线编辑
- 数据映射配置
- 导入规则自定义

## 📞 技术支持

如遇到问题，请检查：
1. **文件格式**: 确保是 .xlsx, .xls 或 .csv 格式
2. **字段映射**: 确保按模板格式填写数据
3. **网络连接**: 确保上传过程网络稳定
4. **权限设置**: 确保有保单管理权限

建议在正式环境使用前，先在测试环境验证数据格式和导入流程。 