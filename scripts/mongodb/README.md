# MongoDB æ•°æ®åº“å‡çº§æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•æ‰§è¡Œå…¬å¸é›†åˆçš„å­—æ®µç»“æ„å‡çº§ï¼Œä»¥æ”¯æŒå®Œæ•´çš„ä¿é™©å…¬å¸ç®¡ç†åŠŸèƒ½ã€‚

## ğŸ“‹ å‡çº§å†…å®¹

### æ–°å¢å­—æ®µåˆ—è¡¨

| å­—æ®µåˆ†ç±» | å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|---------|-------|------|------|
| **åŸºæœ¬ä¿¡æ¯** | `company_code` | String | ä¿é™©å…¬å¸ä»£ç  |
| **è´Ÿè´£äººä¿¡æ¯** | `principles_cn` | String | è´Ÿè´£äººä¸­æ–‡å |
| | `principles_en` | String | è´Ÿè´£äººè‹±æ–‡å |
| | `contact_person` | String | è”ç»œäºº |
| **è”ç³»æ–¹å¼** | `tel_no` | String | å›ºå®šç”µè¯ |
| | `mobile` | String | ç§»åŠ¨ç”µè¯ |
| **ä¸­æ–‡åœ°å€** | `address_cn_province` | String | çœ/è‡ªæ²»åŒº/ç›´è¾–å¸‚ |
| | `address_cn_city` | String | å¸‚ |
| | `address_cn_district` | String | å¿/åŒº |
| | `address_cn_detail` | String | è¯¦ç»†åœ°å€ |
| **è‹±æ–‡åœ°å€** | `address_en_province` | String | Province/State |
| | `address_en_city` | String | City |
| | `address_en_district` | String | District |
| | `address_en_detail` | String | Detailed Address |
| **ä¸šåŠ¡ä¿¡æ¯** | `broker_code` | String | ç»çºªäººä»£ç  |
| | `link` | String | ç›¸å…³é“¾æ¥ |
| **ç™»å½•ä¿¡æ¯** | `username` | String | ç”¨æˆ·å |
| | `password_hash` | String | å¯†ç å“ˆå¸Œå€¼ |
| **æ‰©å±•ä¿¡æ¯** | `remark1` | String | å¤‡æ³¨1 |
| | `remark2` | String | å¤‡æ³¨2 |
| | `email_template` | String | é‚®ç®±æ¨¡ç‰ˆ |
| | `payment_notification` | String | ç¼´è´¹è´¦å·é€šçŸ¥ |
| **ç³»ç»Ÿå­—æ®µ** | `submitted_by` | String | æäº¤äºº |

### æ–°å»ºç´¢å¼•

- å•å­—æ®µç´¢å¼•ï¼šå…¬å¸ä»£ç ã€è´Ÿè´£äººå§“åã€è”ç»œäººã€è”ç³»æ–¹å¼ã€ç»çºªäººä»£ç ç­‰
- å¤åˆç´¢å¼•ï¼šåœ°å€ç»„åˆã€çŠ¶æ€+æœ‰æ•ˆæœŸã€å…¬å¸åç§°+ä»£ç ç­‰

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### å‰ç½®æ¡ä»¶

1. **MongoDB è¿æ¥**: ç¡®ä¿å¯ä»¥è¿æ¥åˆ° MongoDB æ•°æ®åº“
2. **æƒé™éªŒè¯**: ç¡®ä¿æœ‰è¯»å†™æ•°æ®åº“çš„æƒé™
3. **å¤‡ä»½ç­–ç•¥**: å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰å…ˆåšå®Œæ•´å¤‡ä»½

### 1. ä¿®æ”¹æ•°æ®åº“åç§°

åœ¨æ‰§è¡Œè„šæœ¬å‰ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹è„šæœ¬ä¸­çš„æ•°æ®åº“åç§°ï¼š

```javascript
// å°† 'yufung_admin' æ›¿æ¢ä¸ºä½ çš„å®é™…æ•°æ®åº“å
use('your_database_name');
```

### 2. æ‰§è¡Œå‡çº§è„šæœ¬

#### æ–¹æ³•ä¸€: ä½¿ç”¨ MongoDB Shell

```bash
# è¿æ¥åˆ° MongoDB
mongosh "mongodb://localhost:27017"

# æˆ–è¿æ¥åˆ°è¿œç¨‹æ•°æ®åº“
mongosh "mongodb://username:password@your-server:27017/your_database"

# æ‰§è¡Œå‡çº§è„šæœ¬
load('scripts/mongodb/upgrade_company_schema.js')
```

#### æ–¹æ³•äºŒ: ç›´æ¥æ‰§è¡Œæ–‡ä»¶

```bash
# æœ¬åœ°æ‰§è¡Œ
mongosh your_database_name --file scripts/mongodb/upgrade_company_schema.js

# è¿œç¨‹æ‰§è¡Œ
mongosh "mongodb://username:password@your-server:27017/your_database" --file scripts/mongodb/upgrade_company_schema.js
```

### 3. éªŒè¯å‡çº§ç»“æœ

å‡çº§å®Œæˆåï¼Œè„šæœ¬ä¼šè‡ªåŠ¨éªŒè¯ï¼š

- âœ… å­—æ®µæ˜¯å¦æ­£ç¡®æ·»åŠ 
- âœ… ç´¢å¼•æ˜¯å¦æˆåŠŸåˆ›å»º
- âœ… æ•°æ®è¿ç§»æ˜¯å¦å®Œæˆ
- âœ… å¤‡ä»½æ˜¯å¦æˆåŠŸåˆ›å»º

### 4. æµ‹è¯•åº”ç”¨ç¨‹åº

å‡çº§å®Œæˆåï¼Œå¯åŠ¨åº”ç”¨ç¨‹åºè¿›è¡Œæµ‹è¯•ï¼š

```bash
# å¯åŠ¨åç«¯æœåŠ¡
cd your-backend-project
go run main.go

# å¯åŠ¨å‰ç«¯æœåŠ¡
cd your-frontend-project
npm start
```

è®¿é—®å…¬å¸ç®¡ç†é¡µé¢ï¼Œæµ‹è¯•æ–°å­—æ®µçš„æ˜¾ç¤ºå’Œç¼–è¾‘åŠŸèƒ½ã€‚

## ğŸ”„ å›æ»šæ“ä½œ

å¦‚æœå‡çº§åå‘ç°é—®é¢˜éœ€è¦å›æ»šï¼š

### æ‰§è¡Œå›æ»šè„šæœ¬

```bash
# æ–¹æ³•ä¸€: MongoDB Shell ä¸­æ‰§è¡Œ
load('scripts/mongodb/rollback_company_schema.js')

# æ–¹æ³•äºŒ: ç›´æ¥æ‰§è¡Œæ–‡ä»¶
mongosh your_database_name --file scripts/mongodb/rollback_company_schema.js
```

### å›æ»šåéªŒè¯

å›æ»šè„šæœ¬ä¼šï¼š

- âœ… åˆ é™¤æ‰€æœ‰æ–°å¢å­—æ®µ
- âœ… åˆ é™¤æ–°å»ºç´¢å¼•
- âœ… åˆ›å»ºå›æ»šå‰çŠ¶æ€å¤‡ä»½
- âœ… éªŒè¯å›æ»šç»“æœ

## ğŸ“Š æ‰§è¡Œç¤ºä¾‹

### æˆåŠŸå‡çº§çš„è¾“å‡ºç¤ºä¾‹

```
=== å¼€å§‹å‡çº§å…¬å¸é›†åˆå­—æ®µç»“æ„ ===
1. åˆ›å»ºé›†åˆå¤‡ä»½...
âœ“ å¤‡ä»½å®Œæˆï¼Œå¤‡ä»½é›†åˆå: companies_backup
2. ä¸ºç°æœ‰å…¬å¸æ–‡æ¡£æ·»åŠ æ–°å­—æ®µ...
âœ“ å­—æ®µæ·»åŠ å®Œæˆ
3. æ‰§è¡Œæ•°æ®è¿ç§»...
âœ“ æ•°æ®è¿ç§»å®Œæˆ
4. åˆ›å»ºæ–°å­—æ®µç´¢å¼•...
âœ“ ç´¢å¼•åˆ›å»ºå®Œæˆ
5. éªŒè¯å‡çº§ç»“æœ...
æ€»å…¬å¸æ•°é‡: 5
âœ“ æ‰€æœ‰æ–°å­—æ®µå·²æˆåŠŸæ·»åŠ 
6. å½“å‰ç´¢å¼•åˆ—è¡¨:
- _id_: {"_id":1}
- company_code_1: {"company_code":1}
- principles_cn_1: {"principles_cn":1}
...
=== å…¬å¸é›†åˆå­—æ®µå‡çº§å®Œæˆ ===
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰

1. **å®Œæ•´å¤‡ä»½**: å»ºè®®ä½¿ç”¨ `mongodump` åˆ›å»ºå®Œæ•´æ•°æ®åº“å¤‡ä»½
2. **æµ‹è¯•ç¯å¢ƒéªŒè¯**: å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œå¹¶éªŒè¯
3. **åœæœºæ—¶é—´**: è¯„ä¼°æ‰§è¡Œæ—¶é—´ï¼Œå¯èƒ½éœ€è¦å®‰æ’ç»´æŠ¤çª—å£
4. **å›æ»šæ–¹æ¡ˆ**: å‡†å¤‡å›æ»šè®¡åˆ’

### æ•°æ®è¿ç§»è¯´æ˜

- åŸæœ‰ `address` å­—æ®µä¼šä¿ç•™ï¼Œæ–°å¢çš„ä¸­è‹±æ–‡åœ°å€å­—æ®µä¸ºç©º
- è„šæœ¬ä¼šå°†åŸæœ‰åœ°å€å†…å®¹å¤åˆ¶åˆ° `address_cn_detail` å­—æ®µ
- å¦‚éœ€è¦è‡ªå®šä¹‰åœ°å€è§£æé€»è¾‘ï¼Œè¯·ä¿®æ”¹è„šæœ¬ä¸­çš„æ•°æ®è¿ç§»éƒ¨åˆ†

### æ€§èƒ½è€ƒè™‘

- è„šæœ¬ä½¿ç”¨ `background: true` åˆ›å»ºç´¢å¼•ï¼Œä¸ä¼šé˜»å¡å…¶ä»–æ“ä½œ
- å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œç´¢å¼•åˆ›å»ºå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
- å¯ä»¥é€šè¿‡ `db.currentOp()` ç›‘æ§ç´¢å¼•åˆ›å»ºè¿›åº¦

## ğŸ› ï¸ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹é»˜è®¤å€¼

å¦‚æœéœ€è¦ä¸ºæ–°å­—æ®µè®¾ç½®ä¸åŒçš„é»˜è®¤å€¼ï¼Œå¯ä»¥ä¿®æ”¹è„šæœ¬ä¸­çš„ `$set` éƒ¨åˆ†ï¼š

```javascript
$set: {
  "company_code": "DEFAULT_CODE",  // è®¾ç½®é»˜è®¤ä»£ç 
  "submitted_by": "SYSTEM",        // è®¾ç½®é»˜è®¤æäº¤äºº
  // ... å…¶ä»–å­—æ®µ
}
```

### è‡ªå®šä¹‰åœ°å€è§£æ

å¦‚æœåŸæœ‰åœ°å€æ•°æ®æœ‰ç‰¹å®šæ ¼å¼ï¼Œå¯ä»¥åœ¨æ•°æ®è¿ç§»éƒ¨åˆ†æ·»åŠ è§£æé€»è¾‘ï¼š

```javascript
// ç¤ºä¾‹ï¼šè§£æ "åŒ—äº¬å¸‚æœé˜³åŒºä¸‰ç¯è·¯123å·" æ ¼å¼çš„åœ°å€
if (doc.address && doc.address.includes("å¸‚")) {
  let addressParts = parseChineseAddress(doc.address);
  updateDoc["address_cn_province"] = addressParts.province;
  updateDoc["address_cn_city"] = addressParts.city;
  // ...
}
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥ MongoDB è¿æ¥å’Œæƒé™
2. æŸ¥çœ‹è„šæœ¬è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯
3. ç¡®è®¤æ•°æ®åº“åç§°å’Œé›†åˆåç§°æ˜¯å¦æ­£ç¡®
4. å¦‚æœ‰ç–‘é—®ï¼Œè¯·ä¿å­˜å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—ä»¥ä¾¿æ’æŸ¥ 